# Producer that sends messages THROUGH the partition remapper proxy
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-producer
  namespace: confluent
  labels:
    app: kafka-producer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-producer
  template:
    metadata:
      labels:
        app: kafka-producer
    spec:
      containers:
        - name: kafka-producer
          image: confluentinc/cp-kafka:7.5.0
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for Kafka and Proxy to be ready..."
              sleep 90

              # Connect through the partition remapper proxy
              PROXY_BOOTSTRAP="test-remapper.confluent.svc.cluster.local:9092"

              echo "Starting continuous message production through proxy..."
              echo "Proxy endpoint: $PROXY_BOOTSTRAP"
              count=0
              while true; do
                for i in $(seq 1 50); do
                  count=$((count + 1))
                  # Use different keys to distribute across virtual partitions
                  key="key-$((count % 100))"
                  echo "$key:{\"id\": $count, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"partition_key\": \"$key\", \"source\": \"kafka-producer\"}"
                done | kafka-console-producer \
                  --bootstrap-server $PROXY_BOOTSTRAP \
                  --topic remapper-test-topic \
                  --property "parse.key=true" \
                  --property "key.separator=:"

                echo "Produced 50 messages (total: $count) through proxy. Sleeping 10 seconds..."
                sleep 10
              done
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
      restartPolicy: Always
